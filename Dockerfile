# syntax = docker/dockerfile:1

# Adjust NODE_VERSION as desired
ARG NODE_VERSION=14.20.0
ARG GAC_PATH=/
FROM node:${NODE_VERSION}-slim as base

LABEL fly_launch_runtime="NodeJS"

# NodeJS app lives here
WORKDIR /app

# Set production environment
ENV NODE_ENV=production
ENV CREDS=ewogICAgInR5cGUiOiAic2VydmljZV9hY2NvdW50IiwKICAgICJwcm9qZWN0X2lkIjogIndlYmRldm5hdiIsCiAgICAicHJpdmF0ZV9rZXlfaWQiOiAiM2Q3NDM5YTkwOTJhMzg2NjE0MWVmMjMzNjdiMTU5ZTY3ZDIxZDkyNiIsCiAgICAicHJpdmF0ZV9rZXkiOiAiLS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRQzFlWEw4ckJZTmcxcTMKNGVHR25zUjFMdGhsUlJxdjJ4cXhtVk1lM0lKMHRVdDBKZm0vRTlMek50MUZiZVBUbkFmWWhwTytMcXk1ajlscApOQmdkTWdNbSt0WWhINVhja3MxdGt4czB3RlZqYW1UaS9jV2UwWUI4eWZHYlB6cVJidU1laFh1andnWVRUNTdLCnF3b1l6QUZSZWpPUndCUGdOenZ6dUNaU29ueG5nOFFzUmVEM1JMK0dacExaL0lVS2IrV3RWOG5lY2VlanZ1TTEKUGdiQzI1QXBzc04wZklleUxyaCtZNVFqYzhPcndHazNIU085WDVkWC9tRG5oKzFvQlc4Yi8ycnoxblBZQVRNZwpWNXdEWXZndmNHdUpGZUI4czR3Tk5kdERmbzcrZ3lITzV2akVwR2NLRE44ODJBY0srUFdnemgzRUVQd3lLTEgwCnZhaG11dC9mQWdNQkFBRUNnZ0VBTE1jeDYwemZDQ2lRT3UwK2c4UXJQNnIyZEU2UDNqS1hMSmxqbkNyVytjcysKT2dPZzAxZ2w1aU4waDh3c3VpczIrR09Fa3huYlB0SlMyQldsbVphY2xvS3dVVzRFd1c5cnh3elVXcmpXbVBoSQp1b1hadkcxL1ljdEdsWU1OaFpNeDhYY0lZZ2pmRE9iSmpNS1ZkRGJxWUZ0aDNDWGtBYUEvWjh6WmoreE4vQkJwClVLcWtUaE1jWFYrR0xlM1A5Rnh2ZG95Y0ZlRXZvb05aZlg1OWFzbVBSRGJkRUN1NFZjY2JJOUVQWFVtTE55dGUKQ0dLd05Wai9peCtHd3RyTDZwU0k5dGVNc1lrSzRjZ1JncEdaaE1yWGphSWRITVIrOHppSktac0E4Nk5IK0MxOApRcnA0MkNERUhCSmJ6bThhVk5zUU5KbjM2WHoxWEk0RlA4K1hBa2ZEQ1FLQmdRRHc5SE9CeW4razMwd2xrUktxCmcvK2Z2NnBTMFdNQWllcklLQ21HN0w1UFJvdUU5NlJCUFJiM0NWMnhyV1BwOW93djBVejFkTnNlbHhDbFFuRDgKcnRQM0NRUUNBdHUzK3FMV1dCNWNrUm4weXVEVjA3ZnY0MlI5YkJSYWlLdlRUVGJsRnB0WWhxSXAvWno2SS9ydApBdEd1Tzc4bjN2QS8vUzNOMVFJVlB4NGczUUtCZ1FEQXpqc2Y2MkhTZVBFK0FjRVBPU0ZzTlNML3JkRFdlN244CkdyWHhmMGhjSXI1Y1QvZkpUcFhWWTZ0VVc3eWFwSFlzRW5QY3FMZlFEd0ZOUEJ0UU1Xdk1CTnBVdFUwc2tTanQKeUVEb2w2Zng5S0JpbytGTzhHc0dMR3hyMXJxdE16clpGOTdIc3V6cEhiK2krYUdFcXpob0oyMGxUUk16eE5ncApVclhnNnUrNTZ3S0JnUURsaWZuL1Nza09aeXBESDFDSTMvWkVXSElKTXk3ODlHV1ZCNjJIdTBBUWhVT2tCOFdSCjRJQmdGYXdMOXdHWGdDZEw1amRLSFdnZ1hBaWZaZ3Y4cXcrQjVqVExOYTNhTmdtcDU0Z0U1cld6WFJHU29YNDQKS0ljeWRDTnZtNE1VYUJwRFlxWGFUMmRzV1EyUnZYVHRGQ0pydUw4QlhIL0NkWTJNNTc1MFB3eVVnUUtCZ0RzaApSR3Eyb29xTkF0ZFViR1FCem1sRUpwYXBOT29DaWZoeUxLaUNzNnRtRUdGNU9QSHBBdlN0bTRiRWw2UUptaUJNCkRISjQzOTZVSzM4SFZ3MFNDeEJIMExtMzNKSTFkb3J1SmxIdTZOZkFnVXVmSE9NN3dtYmpTdUVMdXJhUmhwTzcKeVZ3UFdLN3BxN01Nd2VkUkozeHgwdnhrbGVZRGtaT2l4UnJVa202L0FvR0JBTWRwcGZBYnlYcHFzNlpHZEZKTAo2enh3dGFCa2hjTVlWL2NBMUM4STRrM0NzMlpWN2JjdVVaaFpDTUVtT3JMQ0t0STJTZmlGWXloaVdvYU54cFVZClphc09FckJjcVh0bTJvZzFEaVh0Q3R6d0pPV3VXK1lXSWsvM00wSG1TSWRHVktVbkJOeEtEejF3NVRkWEkvR3MKTms2MG1qMWwxcXU2M2FBemFqWWhWd2hQCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0KIiwKICAgICJjbGllbnRfZW1haWwiOiAic3VraS10ZXh0LXRvLXNwZWVjaEB3ZWJkZXZuYXYuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICAgImNsaWVudF9pZCI6ICIxMDYxMDY5OTEwODQ5NzI5Mjg3MjEiLAogICAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAgICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICAgImF1dGhfcHJvdmlkZXJfeDUwOV9jZXJ0X3VybCI6ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS9vYXV0aDIvdjEvY2VydHMiLAogICAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvc3VraS10ZXh0LXRvLXNwZWVjaCU0MHdlYmRldm5hdi5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKICB9CiAg


# Throw-away build stage to reduce size of final image
FROM base as build

# Install packages needed to build node modules
RUN apt-get update -qq && \
    apt-get install -y python pkg-config build-essential 

# Install node modules
COPY --link package.json package-lock.json .
RUN npm install --production=false

# Copy application code
COPY --link . .

# Remove development dependencies
RUN npm prune --production


# Final stage for app image
FROM base

# Copy built application
COPY --from=build /app /app

# Start the server by default, this can be overwritten at runtime
CMD [ "npm", "run", "start" ]
